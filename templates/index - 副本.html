<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMD脚本管理器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 10px;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 5px;
                padding: 15px;
                border-radius: 15px;
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-weight: 300;
            font-size: 2.5rem;
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--secondary-color);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .scripts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .scripts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            .scripts-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        .script-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            height: fit-content;
        }

        .script-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .script-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .script-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-running {
            background: var(--success-color);
            color: white;
        }

        .status-stopped {
            background: var(--danger-color);
            color: white;
        }

        .status-disabled {
            background: var(--dark-color);
            color: white;
        }

        .stop-reason-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stop-reason-manual {
            background: #6c757d;
            color: white;
        }

        .stop-reason-crash {
            background: #dc3545;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* 异常中断状态的脚本卡片红色闪烁边框 - 更明显的效果 */
        .script-card.crash-status {
            border: 4px solid #dc3545;
            animation: flashBorder 1s infinite;
            box-shadow: 0 0 30px rgba(220, 53, 69, 0.5);
        }

        @keyframes flashBorder {
            0% { 
                border-color: #dc3545;
                box-shadow: 0 0 30px rgba(220, 53, 69, 0.5);
                transform: scale(1);
            }
            50% { 
                border-color: #ff1a1a;
                box-shadow: 0 0 50px rgba(255, 26, 26, 0.8);
                transform: scale(1.02);
            }
            100% { 
                border-color: #dc3545;
                box-shadow: 0 0 30px rgba(220, 53, 69, 0.5);
                transform: scale(1);
            }
        }

        /* 状态徽章闪烁效果 */
        .status-stopped.flash-red {
            animation: flashStatusBadge 1s infinite;
        }

        .stop-reason-crash.flash-red {
            animation: flashStatusBadge 1s infinite;
        }

        @keyframes flashStatusBadge {
            0% { 
                background-color: #dc3545;
                box-shadow: 0 0 10px rgba(220, 53, 69, 0.3);
            }
            50% { 
                background-color: #ff1a1a;
                box-shadow: 0 0 20px rgba(255, 26, 26, 0.6);
            }
            100% { 
                background-color: #dc3545;
                box-shadow: 0 0 10px rgba(220, 53, 69, 0.3);
            }
        }

        /* 通知历史样式 */
        .notification-history-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }
        
        .notification-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .notification-item.success {
            border-left: 4px solid #198754;
        }
        
        .notification-item.error {
            border-left: 4px solid #dc3545;
        }
        
        .notification-item.warning {
            border-left: 4px solid #fd7e14;
        }
        
        .notification-item.info {
            border-left: 4px solid #0dcaf0;
        }
        
        .notification-time {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .notification-message {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .notification-type-badge {
            font-size: 0.75em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .script-info {
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .info-label {
            color: #6c757d;
            font-weight: 500;
        }

        .info-value {
            color: var(--dark-color);
            font-weight: 600;
        }

        .script-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 480px) {
            .script-actions {
                gap: 5px;
            }
            .btn-custom {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }

        .btn-custom {
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-start {
            background: var(--success-color);
            color: white;
        }

        .btn-start:hover {
            background: #229954;
            color: white;
        }

        .btn-stop {
            background: var(--danger-color);
            color: white;
        }

        .btn-stop:hover {
            background: #c0392b;
            color: white;
        }

        .btn-logs {
            background: var(--info-color);
            color: white;
        }

        .btn-logs:hover {
            background: #138496;
            color: white;
        }

        .btn-toggle {
            background: var(--warning-color);
            color: white;
        }

        .btn-toggle:hover {
            background: #d68910;
            color: white;
        }

        .log-container {
            background: #000000;
            color: #00ff00;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            border: 2px solid #333;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.1);
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .log-container {
                max-height: 300px;
                padding: 15px;
                font-size: 0.8rem;
            }
        }

        .log-line {
             margin-bottom: 5px;
             line-height: 1.4;
             animation: fadeIn 0.3s ease-in;
         }

         @keyframes fadeIn {
              from { opacity: 0; }
              to { opacity: 1; }
          }

          /* CMD输出区域样式 */
          .cmd-output-container {
              margin: 15px 0;
              border: 1px solid #333;
              border-radius: 8px;
              background: #000000;
              overflow: hidden;
          }

          .cmd-output-header {
              background: #1a1a1a;
              padding: 8px 12px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              border-bottom: 1px solid #333;
          }

          .cmd-output-title {
              color: #00ff00;
              font-size: 0.85rem;
              font-weight: 500;
          }

          .cmd-output-header .btn {
              padding: 2px 6px;
              border-color: #555;
              color: #ccc;
          }

          .cmd-output-header .btn:hover {
              background: #333;
              border-color: #777;
              color: #fff;
          }

          .cmd-output-content {
              background: #000000;
              color: #00ff00;
              font-family: 'Courier New', monospace;
              font-size: 0.8rem;
              line-height: 1.3;
              padding: 10px;
              max-height: 200px;
              overflow-y: auto;
              white-space: pre-wrap;
              word-break: break-all;
          }

          .cmd-output-content.collapsed {
              display: none;
          }

          .loading-output {
              color: #888;
              font-style: italic;
              text-align: center;
              padding: 10px;
          }

          .cmd-line {
              margin-bottom: 2px;
              animation: fadeIn 0.2s ease-in;
          }

          @media (max-width: 768px) {
              .cmd-output-content {
                  max-height: 150px;
                  font-size: 0.75rem;
                  padding: 8px;
              }
          }

        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 144, 220, 0.25);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-custom {
            border-radius: 10px;
            border: none;
            padding: 15px 20px;
        }

        .navbar-custom {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .navbar-custom .d-flex {
                flex-direction: column;
                gap: 15px;
            }
            .navbar-custom .d-flex > div:first-child {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;
            }
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 110px; /* 向左移动，避免与通知重叠 */
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--secondary-color);
            color: white;
            border: none;
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .refresh-btn:hover {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        /* 固定的通知历史按钮 */
        .notification-history-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 1001; /* 比刷新按钮层级更高 */
        }

        .notification-history-btn:hover {
            background: #0056b3;
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .script-actions {
                justify-content: center;
            }
            
            /* 移动端按钮布局调整 */
            .refresh-btn {
                bottom: 20px;
                right: 80px;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .notification-history-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 1rem;
            }
        }

        /* 分组和拖拽样式 */
        .group-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 120px;
            transition: all 0.3s ease;
        }

        .group-container.drag-over {
            border-color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.1);
            transform: scale(1.02);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .group-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }

        .group-actions {
            display: flex;
            gap: 8px;
        }

        .group-scripts {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            min-height: 60px;
        }

        .ungrouped-container {
            background: #fff;
            border: 2px dashed #ced4da;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 120px;
        }

        .ungrouped-container.drag-over {
            border-color: var(--warning-color);
            background: rgba(243, 156, 18, 0.1);
        }

        .script-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
            cursor: grabbing;
        }

        .script-card[draggable="true"] {
            cursor: grab;
        }

        .script-card[draggable="true"]:hover {
            transform: translateY(-3px) scale(1.02);
        }

        .drop-zone {
            border: 2px dashed transparent;
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: var(--success-color);
            background: rgba(39, 174, 96, 0.1);
        }

        .group-empty-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }

        .add-group-btn {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .add-group-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- 头部 -->
            <div class="header">
                <h1><i class="bi bi-terminal"></i> CMD脚本管理器</h1>
                <p>专业的命令行脚本监控与管理平台</p>
            </div>

            <!-- 统计信息 -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                    <div class="stats-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">总脚本数</h6>
                                <h3 class="mb-0" id="total-scripts">0</h3>
                            </div>
                            <div class="text-primary">
                                <i class="bi bi-file-earmark-code" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                    <div class="stats-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">运行中</h6>
                                <h3 class="mb-0 text-success" id="running-scripts">0</h3>
                            </div>
                            <div class="text-success">
                                <i class="bi bi-play-circle" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                    <div class="stats-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">已停止</h6>
                                <h3 class="mb-0 text-danger" id="stopped-scripts">0</h3>
                            </div>
                            <div class="text-danger">
                                <i class="bi bi-stop-circle" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                    <div class="stats-card">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">自动重启</h6>
                                <h3 class="mb-0 text-info" id="auto-restart-scripts">0</h3>
                            </div>
                            <div class="text-info">
                                <i class="bi bi-arrow-repeat" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="navbar-custom p-3 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-primary btn-custom" onclick="showAddScriptModal()">
                            <i class="bi bi-plus-circle"></i> 添加脚本
                        </button>
                        <button class="btn btn-success btn-custom" onclick="startAllScripts()">
                            <i class="bi bi-play-fill"></i> 启动全部
                        </button>
                        <button class="btn btn-danger btn-custom" onclick="stopAllScripts()">
                            <i class="bi bi-stop-fill"></i> 停止全部
                        </button>
                    </div>
                    <div>
                        <span class="text-muted">最后更新: <span id="last-update">-</span></span>
                    </div>
                </div>
            </div>

            <!-- 分组管理操作区 -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex gap-2">
                    <button type="button" class="btn add-group-btn" onclick="showCreateGroupModal()">
                        <i class="bi bi-folder-plus"></i> 创建分组
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="toggleGroupView()">
                        <i class="bi bi-grid-3x3-gap" id="view-toggle-icon"></i>
                        <span id="view-toggle-text">分组视图</span>
                    </button>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableDragDrop" checked>
                    <label class="form-check-label" for="enableDragDrop">
                        启用拖拽
                    </label>
                </div>
            </div>

            <!-- 脚本列表 -->
            <div id="scripts-container">
                <div class="text-center py-5">
                    <div class="loading"></div>
                    <p class="mt-3 text-muted">正在加载脚本列表...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 刷新按钮 -->
    <button class="refresh-btn" onclick="loadScripts()" title="刷新">
        <i class="bi bi-arrow-clockwise"></i>
    </button>

    <!-- 固定的通知历史按钮 -->
    <button class="notification-history-btn" onclick="showNotificationHistory()" title="查看通知历史">
        <i class="bi bi-clock-history"></i>
    </button>

    <!-- 添加脚本模态框 -->
    <div class="modal fade" id="addScriptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 添加新脚本</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addScriptForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">脚本ID *</label>
                                <input type="text" class="form-control" id="scriptId" required>
                                <div class="form-text">唯一标识符，只能包含字母、数字和下划线</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">脚本名称 *</label>
                                <input type="text" class="form-control" id="scriptName" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">执行命令 *</label>
                            <input type="text" class="form-control" id="scriptCommand" required>
                            <div class="form-text">例如: ping -t 127.0.0.1 或 python script.py</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">工作目录</label>
                            <input type="text" class="form-control" id="scriptWorkingDir">
                            <div class="form-text">留空则使用默认目录</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <textarea class="form-control" id="scriptDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="scriptAutoRestart" checked>
                                    <label class="form-check-label" for="scriptAutoRestart">
                                        自动重启
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="scriptEnabled">
                                    <label class="form-check-label" for="scriptEnabled">
                                        立即启用
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addScript()">添加脚本</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建分组模态框 -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建分组</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createGroupForm">
                        <div class="mb-3">
                            <label for="groupId" class="form-label">分组ID *</label>
                            <input type="text" class="form-control" id="groupId" required>
                            <div class="form-text">用于内部标识，建议使用英文字母和数字</div>
                        </div>
                        <div class="mb-3">
                            <label for="groupName" class="form-label">分组名称 *</label>
                            <input type="text" class="form-control" id="groupName" required>
                        </div>
                        <div class="mb-3">
                            <label for="groupDescription" class="form-label">分组描述</label>
                            <textarea class="form-control" id="groupDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createGroup()">创建分组</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑分组模态框 -->
    <div class="modal fade" id="editGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑分组</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editGroupForm">
                        <input type="hidden" id="editGroupId">
                        <div class="mb-3">
                            <label for="editGroupName" class="form-label">分组名称 *</label>
                            <input type="text" class="form-control" id="editGroupName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editGroupDescription" class="form-label">分组描述</label>
                            <textarea class="form-control" id="editGroupDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateGroup()">保存更改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 日志查看模态框 -->
    <div class="modal fade" id="logsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-file-text"></i> 脚本日志 - <span id="log-script-name"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">刷新日志</button>
                            <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="logLines">
                                <option value="50">最近50行</option>
                                <option value="100" selected>最近100行</option>
                                <option value="200">最近200行</option>
                                <option value="500">最近500行</option>
                            </select>
                        </div>
                        <div>
                            <small class="text-muted">实时更新: <span id="log-update-time">-</span></small>
                        </div>
                    </div>
                    <div class="log-container" id="log-content">
                        <div class="text-center py-3">
                            <div class="loading"></div>
                            <p class="mt-2 mb-0">正在加载日志...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-info-circle text-primary me-2" id="toast-icon"></i>
                <strong class="me-auto">系统通知</strong>
                <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="showNotificationHistory()" title="查看通知历史">
                    <i class="bi bi-clock-history"></i>
                </button>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-body">
                消息内容
            </div>
        </div>
    </div>

    <!-- 通知历史模态框 -->
    <div class="modal fade" id="notificationHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-clock-history"></i> 通知历史
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">最近100条通知记录</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearNotificationHistory()">
                            <i class="bi bi-trash"></i> 清空历史
                        </button>
                    </div>
                    <div id="notification-history-list" class="notification-history-container">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox"></i>
                            <p class="mt-2">暂无通知记录</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentLogScript = null;
        let logUpdateInterval = null;
        
        // 分组相关变量
        let groupsData = {};
        let ungroupedScripts = [];
        let isGroupView = false;
        let isDragEnabled = true;
        let draggedScript = null;

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            loadScriptsAndGroups();
            
            // 每30秒自动刷新脚本列表
            setInterval(loadScriptsAndGroups, 30000);
            
            // 每5秒更新CMD输出
            setInterval(updateAllCmdOutputs, 5000);
            
            // 每5秒检查脚本状态变化（用于检测异常退出）
            setInterval(checkScriptStatusChanges, 2000);
            
            // 每10秒检查异常中断状态并自动重启
            setInterval(checkCrashStatusAndAutoRestart, 10000);
        });

        // 加载脚本和分组数据
        async function loadScriptsAndGroups() {
            try {
                // 并行加载脚本和分组数据
                const [scriptsResponse, groupsResponse] = await Promise.all([
                    fetch('/api/scripts'),
                    fetch('/api/groups')
                ]);
                
                if (!scriptsResponse.ok) {
                    throw new Error(`加载脚本失败: HTTP ${scriptsResponse.status}`);
                }
                
                if (!groupsResponse.ok) {
                    throw new Error(`加载分组失败: HTTP ${groupsResponse.status}`);
                }
                
                const scriptsData = await scriptsResponse.json();
                const groupsDataResponse = await groupsResponse.json();
                
                // 处理脚本数据
                let scripts;
                if (Array.isArray(scriptsData)) {
                    scripts = scriptsData;
                } else if (typeof scriptsData === 'object' && scriptsData !== null) {
                    scripts = Object.keys(scriptsData).map(id => ({
                        id: id,
                        ...scriptsData[id]
                    }));
                } else {
                    throw new Error('脚本数据格式不正确');
                }
                
                // 保存分组数据
                groupsData = groupsDataResponse.groups || [];
                ungroupedScripts = groupsDataResponse.ungrouped_scripts || [];
                
                // 渲染界面
                if (isGroupView) {
                    renderGroupedScripts(scripts);
                } else {
                    renderScripts(scripts);
                }
                
                updateStats(scripts);
                updateLastUpdateTime();
                
                // 延迟更新CMD输出
                setTimeout(() => {
                    updateAllCmdOutputs();
                }, 500);
                
            } catch (error) {
                console.error('加载数据失败:', error);
                showErrorContainer(error.message);
            }
        }

        // 加载脚本列表（保留兼容性）
        async function loadScripts() {
            try {
                const response = await fetch('/api/scripts');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // 检查数据格式并转换为数组
                let scripts;
                if (Array.isArray(data)) {
                    scripts = data;
                } else if (typeof data === 'object' && data !== null) {
                    // 如果是对象，转换为数组
                    scripts = Object.keys(data).map(id => ({
                        id: id,
                        ...data[id]
                    }));
                } else {
                    throw new Error('API返回的数据格式不正确');
                }
                
                renderScripts(scripts);
                updateStats(scripts);
                updateLastUpdateTime();
                
                // 延迟一下再更新CMD输出，确保DOM已渲染
                setTimeout(() => {
                    updateAllCmdOutputs();
                }, 500);
            } catch (error) {
                console.error('加载脚本失败:', error);
                
                // 在页面上显示详细错误信息
                const container = document.getElementById('scripts-container');
                container.innerHTML = `
                    <div class="alert alert-danger alert-custom" role="alert">
                        <h4 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> 加载脚本列表失败</h4>
                        <p><strong>错误详情:</strong> ${error.message}</p>
                        <hr>
                        <p class="mb-0">
                            <strong>可能的原因:</strong><br>
                            • 服务器连接失败 (检查服务是否正在运行)<br>
                            • 配置文件读取错误 (检查 cmd_config.json 格式)<br>
                            • 网络连接问题<br>
                            • 服务器内部错误
                        </p>
                        <div class="mt-3">
                            <button class="btn btn-outline-danger" onclick="loadScripts()">
                                <i class="bi bi-arrow-clockwise"></i> 重试
                            </button>
                        </div>
                    </div>
                `;
                
                showToast(`加载失败: ${error.message}`, 'error');
            }
        }

        // 渲染脚本列表
        function renderScripts(scripts) {
            const container = document.getElementById('scripts-container');
            
            if (scripts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
                        <h4 class="text-muted mt-3">暂无脚本</h4>
                        <p class="text-muted">点击上方"添加脚本"按钮开始添加您的第一个脚本</p>
                    </div>
                `;
                return;
            }

            const scriptsHtml = scripts.map(script => createScriptCard(script)).join('');
            
            container.innerHTML = `
                <div class="scripts-grid">
                    ${scriptsHtml}
                </div>
            `;
            
            // 渲染完成后，检查并恢复每个脚本的停止原因显示
            setTimeout(() => {
                scripts.forEach(script => {
                    if (script.status === 'stopped') {
                        checkStopReasonAndHandle(script);
                    }
                });
            }, 100);
        }

        function createScriptCard(script) {
            const draggableAttr = isDragEnabled ? 'draggable="true"' : '';
            return `
                <div class="script-card fade-in" data-script-id="${script.id}" ${draggableAttr} 
                     ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">
                    <div class="script-header">
                        <h3 class="script-title">${script.name}</h3>
                        <div class="d-flex align-items-center gap-2">
                            <span class="status-badge status-${getStatusClass(script)}${script.status === 'stopped' && script.stop_reason ? ' flash-red' : ''}" style="${getStatusText(script) ? 'display: inline-block;' : 'display: none;'}">
                                <i class="bi bi-${getStatusIcon(script)}"></i> ${getStatusText(script) || '状态未知'}
                            </span>
                            <span class="stop-reason-badge" id="stop-reason-${script.id}" style="display: none;">
                                <!-- 停止原因将在这里显示 -->
                            </span>
                        </div>
                    </div>
                    
                    <div class="script-info">
                        <div class="info-item">
                            <span class="info-label">命令:</span>
                            <span class="info-value">${script.command}</span>
                        </div>
                        ${script.pid ? `
                        <div class="info-item">
                            <span class="info-label">进程ID:</span>
                            <span class="info-value">${script.pid}</span>
                        </div>
                        ` : ''}
                        ${script.start_time ? `
                        <div class="info-item">
                            <span class="info-label">启动时间:</span>
                            <span class="info-value">${script.start_time}</span>
                        </div>
                        ` : ''}
                        <div class="info-item">
                            <span class="info-label">重启次数:</span>
                            <span class="info-value">${script.restart_count}</span>
                        </div>
                        ${script.description ? `
                        <div class="info-item">
                            <span class="info-label">描述:</span>
                            <span class="info-value">${script.description}</span>
                        </div>
                        ` : ''}
                        ${script.last_output ? `
                        <div class="info-item">
                            <span class="info-label">最后输出:</span>
                            <span class="info-value" style="font-family: monospace; font-size: 0.8rem;">${script.last_output}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- 实时CMD输出区域 -->
                    ${script.status === 'running' ? `
                    <div class="cmd-output-container" id="cmd-output-${script.id}">
                        <div class="cmd-output-header">
                            <span class="cmd-output-title">
                                <i class="bi bi-terminal"></i> 实时输出
                            </span>
                            <button class="btn btn-sm btn-outline-light" onclick="toggleCmdOutput('${script.id}')" id="toggle-cmd-${script.id}">
                                <i class="bi bi-chevron-up"></i>
                            </button>
                        </div>
                        <div class="cmd-output-content" id="cmd-content-${script.id}">
                            <div class="loading-output">正在加载输出...</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="script-actions">
                        ${script.status === 'running' ? `
                            <button class="btn btn-stop btn-custom" onclick="stopScript('${script.id}')">
                                <i class="bi bi-stop-fill"></i> 停止
                            </button>
                        ` : `
                            <button class="btn btn-start btn-custom" onclick="startScript('${script.id}')">
                                <i class="bi bi-play-fill"></i> 启动
                            </button>
                        `}
                        <button class="btn btn-logs btn-custom" onclick="showLogs('${script.id}', '${script.name}')">
                            <i class="bi bi-file-text"></i> 日志
                        </button>
                        <button class="btn btn-toggle btn-custom" onclick="toggleScript('${script.id}')">
                            <i class="bi bi-${script.enabled ? 'pause' : 'play'}-circle"></i> ${script.enabled ? '禁用' : '启用'}
                        </button>
                        <button class="btn btn-danger btn-custom" onclick="deleteScript('${script.id}')">
                            <i class="bi bi-trash"></i> 删除
                        </button>
                    </div>
                </div>
            `;
        }

        // 获取状态样式类
        function getStatusClass(script) {
            if (!script.enabled) return 'disabled';
            return script.status;
        }

        // 获取状态图标
        function getStatusIcon(script) {
            if (!script.enabled) return 'pause-circle';
            return script.status === 'running' ? 'play-circle-fill' : 'stop-circle';
        }

        // 获取状态文本
        function getStatusText(script) {
            if (!script.enabled) return '已禁用';
            if (script.status === 'running') return '运行中';
            if (script.status === 'stopped') return '已停止';
            return '状态未知';
        }

        // 更新统计信息
        function updateStats(scripts) {
            const total = scripts.length;
            const running = scripts.filter(s => s.status === 'running').length;
            const stopped = scripts.filter(s => s.status === 'stopped').length;
            const autoRestart = scripts.filter(s => s.auto_restart).length;

            document.getElementById('total-scripts').textContent = total;
            document.getElementById('running-scripts').textContent = running;
            document.getElementById('stopped-scripts').textContent = stopped;
            document.getElementById('auto-restart-scripts').textContent = autoRestart;
        }

        // 更新最后更新时间
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }

        // 切换CMD输出显示/隐藏
        function toggleCmdOutput(scriptId) {
            const content = document.getElementById(`cmd-content-${scriptId}`);
            const toggleBtn = document.getElementById(`toggle-cmd-${scriptId}`);
            const icon = toggleBtn.querySelector('i');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.className = 'bi bi-chevron-up';
            } else {
                content.classList.add('collapsed');
                icon.className = 'bi bi-chevron-down';
            }
        }

        // 更新CMD输出内容
        async function updateCmdOutput(scriptId) {
            try {
                const response = await fetch(`/api/scripts/${scriptId}/logs?lines=20`);
                const result = await response.json();
                const contentElement = document.getElementById(`cmd-content-${scriptId}`);
                
                if (contentElement && result.logs && result.logs.length > 0) {
                    const wasAtBottom = contentElement.scrollTop + contentElement.clientHeight >= contentElement.scrollHeight - 5;
                    
                    contentElement.innerHTML = result.logs.map(line => 
                        `<div class="cmd-line">${escapeHtml(line)}</div>`
                    ).join('');
                    
                    if (wasAtBottom) {
                        contentElement.scrollTop = contentElement.scrollHeight;
                    }
                } else if (contentElement) {
                    contentElement.innerHTML = '<div class="loading-output">暂无输出内容</div>';
                }
            } catch (error) {
                console.error(`更新脚本 ${scriptId} 输出失败:`, error);
            }
        }

        // 更新所有运行中脚本的CMD输出
        function updateAllCmdOutputs() {
            const runningContainers = document.querySelectorAll('[id^="cmd-output-"]');
            runningContainers.forEach(container => {
                const scriptId = container.id.replace('cmd-output-', '');
                updateCmdOutput(scriptId);
            });
        }

        // 获取脚本名称
        function getScriptName(scriptId) {
            const scriptCard = document.querySelector(`[data-script-id="${scriptId}"]`);
            if (scriptCard) {
                const titleElement = scriptCard.querySelector('.script-title');
                return titleElement ? titleElement.textContent : scriptId;
            }
            return scriptId;
        }
        
        // 启动脚本
        async function startScript(scriptId) {
            const scriptName = getScriptName(scriptId);
            try {
                const response = await fetch(`/api/scripts/${scriptId}/start`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(`脚本 "${scriptName}" 启动成功`, 'success');
                    // 立即更新状态显示为运行中
                    updateScriptStatusImmediately(scriptId, 'running');
                    // 短暂延迟后再次确认状态
                    setTimeout(() => {
                        updateSingleScriptStatus(scriptId);
                    }, 200);
                } else {
                    showToast(`脚本 "${scriptName}" 启动失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showToast(`启动脚本 "${scriptName}" 时发生错误`, 'error');
            }
        }

        // 停止脚本
        async function stopScript(scriptId) {
            const scriptName = getScriptName(scriptId);
            try {
                const response = await fetch(`/api/scripts/${scriptId}/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: 'manual'
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(`脚本 "${scriptName}" 已停止`, 'success');
                    // 立即更新状态显示为手动停止
                    updateScriptStatusImmediately(scriptId, 'stopped', 'manual');
                    // 短暂延迟后再次确认状态
                    setTimeout(() => {
                        updateSingleScriptStatus(scriptId);
                    }, 200);
                } else {
                    showToast(`停止脚本 "${scriptName}" 失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showToast(`停止脚本 "${scriptName}" 时发生错误`, 'error');
            }
        }

        // 切换脚本启用状态
        async function toggleScript(scriptId) {
            const scriptName = getScriptName(scriptId);
            try {
                const response = await fetch(`/api/scripts/${scriptId}/toggle`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(`脚本 "${scriptName}" 已${result.enabled ? '启用' : '禁用'}`, 'success');
                    // 如果脚本被禁用，立即清除停止原因显示
                    if (!result.enabled) {
                        updateStopReasonDisplay(scriptId, null);
                    }
                    // 添加短暂延迟确保后端状态更新完成，然后只更新当前脚本状态
                    setTimeout(() => {
                        updateSingleScriptStatus(scriptId);
                    }, 500);
                } else {
                    showToast(`切换脚本 "${scriptName}" 状态失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showToast(`切换脚本 "${scriptName}" 状态时发生错误`, 'error');
            }
        }

        // 删除脚本
        async function deleteScript(scriptId) {
            const scriptName = getScriptName(scriptId);
            if (!confirm(`确定要删除脚本 "${scriptName}" 吗？此操作不可恢复。`)) {
                return;
            }

            try {
                const response = await fetch(`/api/scripts/${scriptId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(`脚本 "${scriptName}" 已删除`, 'success');
                    loadScripts();
                } else {
                    showToast(`删除脚本 "${scriptName}" 失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showToast(`删除脚本 "${scriptName}" 时发生错误`, 'error');
            }
        }

        // 显示添加脚本模态框
        function showAddScriptModal() {
            document.getElementById('addScriptForm').reset();
            new bootstrap.Modal(document.getElementById('addScriptModal')).show();
        }

        // 添加脚本
        async function addScript() {
            const form = document.getElementById('addScriptForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                id: document.getElementById('scriptId').value,
                name: document.getElementById('scriptName').value,
                command: document.getElementById('scriptCommand').value,
                working_dir: document.getElementById('scriptWorkingDir').value,
                description: document.getElementById('scriptDescription').value,
                auto_restart: document.getElementById('scriptAutoRestart').checked,
                enabled: document.getElementById('scriptEnabled').checked
            };

            try {
                const response = await fetch('/api/scripts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(`脚本 "${data.name}" 添加成功`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addScriptModal')).hide();
                    loadScripts();
                } else {
                    showToast(`添加脚本 "${data.name}" 失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showToast(`添加脚本 "${data.name}" 时发生错误`, 'error');
            }
        }

        // 显示日志
        async function showLogs(scriptId, scriptName) {
            currentLogScript = scriptId;
            document.getElementById('log-script-name').textContent = scriptName;
            
            const modal = new bootstrap.Modal(document.getElementById('logsModal'));
            modal.show();
            
            await refreshLogs();
            
            // 开始定时刷新日志 - 更频繁的刷新
            if (logUpdateInterval) {
                clearInterval(logUpdateInterval);
            }
            logUpdateInterval = setInterval(refreshLogs, 2000); // 2秒刷新一次
            
            // 模态框关闭时停止刷新
            document.getElementById('logsModal').addEventListener('hidden.bs.modal', function() {
                if (logUpdateInterval) {
                    clearInterval(logUpdateInterval);
                    logUpdateInterval = null;
                }
            });
        }

        // 刷新日志
        async function refreshLogs() {
            if (!currentLogScript) return;
            
            const lines = document.getElementById('logLines').value;
            
            try {
                const response = await fetch(`/api/scripts/${currentLogScript}/logs?lines=${lines}`);
                const result = await response.json();
                
                const logContent = document.getElementById('log-content');
                if (result.logs.length === 0) {
                    logContent.innerHTML = '<div class="text-center py-3" style="color: #00ff00;">暂无日志内容</div>';
                } else {
                    // 保持滚动位置
                    const wasAtBottom = logContent.scrollTop + logContent.clientHeight >= logContent.scrollHeight - 5;
                    
                    logContent.innerHTML = result.logs.map(line => 
                        `<div class="log-line" style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.4; margin-bottom: 2px;">${escapeHtml(line)}</div>`
                    ).join('');
                    
                    // 如果之前在底部，自动滚动到新的底部
                    if (wasAtBottom) {
                        logContent.scrollTop = logContent.scrollHeight;
                    }
                }
                
                document.getElementById('log-update-time').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('刷新日志失败:', error);
            }
        }

        // 启动所有脚本
        async function startAllScripts() {
            if (!confirm('确定要启动所有已启用的脚本吗？')) {
                return;
            }
            
            try {
                const response = await fetch('/api/scripts');
                const scripts = await response.json();
                
                let successCount = 0;
                let totalCount = 0;
                
                for (const script of scripts) {
                    if (script.enabled && script.status !== 'running') {
                        totalCount++;
                        try {
                            const startResponse = await fetch(`/api/scripts/${script.id}/start`, {
                                method: 'POST'
                            });
                            const result = await startResponse.json();
                            if (result.success) {
                                successCount++;
                            }
                        } catch (error) {
                            console.error(`启动脚本 ${script.id} 失败:`, error);
                        }
                    }
                }
                
                showToast(`批量启动完成: ${successCount}/${totalCount} 个脚本启动成功`, 'info');
                loadScripts();
            } catch (error) {
                showToast('批量启动时发生错误', 'error');
            }
        }

        // 停止所有脚本
        async function stopAllScripts() {
            if (!confirm('确定要停止所有正在运行的脚本吗？')) {
                return;
            }
            
            try {
                const response = await fetch('/api/scripts');
                const scripts = await response.json();
                
                let successCount = 0;
                let totalCount = 0;
                
                for (const script of scripts) {
                    if (script.status === 'running') {
                        totalCount++;
                        try {
                            const stopResponse = await fetch(`/api/scripts/${script.id}/stop`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    reason: 'manual'
                                })
                            });
                            const result = await stopResponse.json();
                            if (result.success) {
                                successCount++;
                            }
                        } catch (error) {
                            console.error(`停止脚本 ${script.id} 失败:`, error);
                        }
                    }
                }
                
                showToast(`批量停止完成: ${successCount}/${totalCount} 个脚本停止成功`, 'info');
                loadScripts();
            } catch (error) {
                showToast('批量停止时发生错误', 'error');
            }
        }

        // 检查所有脚本状态变化（用于检测异常退出等情况）
        async function checkScriptStatusChanges() {
            try {
                const response = await fetch('/api/scripts');
                if (!response.ok) {
                    return; // 静默失败，避免干扰用户
                }
                
                const data = await response.json();
                let scripts;
                if (Array.isArray(data)) {
                    scripts = data;
                } else if (typeof data === 'object' && data !== null) {
                    scripts = Object.keys(data).map(id => ({
                        id: id,
                        ...data[id]
                    }));
                } else {
                    return;
                }
                
                // 检查每个脚本的状态变化
                scripts.forEach(script => {
                    const existingCmdOutput = document.querySelector(`#cmd-output-${script.id}`);
                    const shouldHaveCmdOutput = script.status === 'running';
                    
                    // 始终更新脚本状态显示
                    updateSingleScriptStatus(script.id);
                    
                    if (shouldHaveCmdOutput && !existingCmdOutput) {
                        // 脚本正在运行但没有CMD输出容器，需要创建
                        console.log(`检测到脚本 ${script.id} 需要创建CMD输出容器`);
                    } else if (!shouldHaveCmdOutput && existingCmdOutput) {
                        // 脚本已停止，需要查询停止原因来决定是否删除CMD窗口
                        console.log(`检测到脚本 ${script.id} 已停止且存在CMD窗口，查询停止原因...`);
                        checkStopReasonAndHandle(script);
                    }
                });
                
                // 更新统计信息
                updateStats(scripts);
            } catch (error) {
                // 静默失败，避免干扰用户
                console.debug('检查脚本状态变化失败:', error);
            }
        }
        
        // 检查停止原因并处理CMD窗口
        async function checkStopReasonAndHandle(script) {
            try {
                console.log(`开始查询脚本 ${script.id} 的停止原因...`);
                const response = await fetch(`/api/scripts/${script.id}/stop-reason`);
                
                if (!response.ok) {
                    console.error(`查询停止原因API失败: ${response.status} ${response.statusText}`);
                    return;
                }
                
                const result = await response.json();
                const stopReason = result.stop_reason;
                
                console.log(`脚本 ${script.id} 停止原因查询结果:`, result);
                console.log(`脚本 ${script.id} 停止原因: ${stopReason}`);
                
                // 更新停止原因显示
                updateStopReasonDisplay(script.id, stopReason);
                
                const existingCmdOutput = document.querySelector(`#cmd-output-${script.id}`);
                console.log(`脚本 ${script.id} CMD窗口存在状态:`, !!existingCmdOutput);
                
                if (stopReason === 'manual' && existingCmdOutput) {
                    // 手动停止，删除CMD窗口
                    existingCmdOutput.remove();
                    console.log(`✅ 手动停止脚本 ${script.id}，删除CMD输出容器`);
                } else if (stopReason === 'crash') {
                    // 异常退出，保留CMD窗口，自动重启
                    console.log(`🔥 脚本 ${script.id} 异常退出，保留CMD输出容器`);
                    
                    if (script.auto_restart && script.enabled && script.status === 'stopped') {
                        console.log(`🔄 检测到脚本 ${script.id} 异常退出，准备自动重启`);
                        setTimeout(() => {
                            console.log(`🚀 自动重启脚本 ${script.id}`);
                            startScript(script.id);
                        }, 3000); // 延迟3秒重启，避免频繁重启
                    }
                } else {
                    // 未知原因，保留CMD窗口
                    console.log(`❓ 脚本 ${script.id} 停止原因未知(${stopReason})，保留CMD输出容器`);
                }
            } catch (error) {
                console.error(`❌ 查询脚本 ${script.id} 停止原因失败:`, error);
                // 查询失败时保留CMD窗口
                console.log(`🛡️ 查询失败，保留脚本 ${script.id} 的CMD窗口`);
            }
        }
        
        // 检查异常中断状态并自动重启
        async function checkCrashStatusAndAutoRestart() {
            try {
                const response = await fetch('/api/scripts');
                if (!response.ok) {
                    return; // 静默失败
                }
                
                const data = await response.json();
                let scripts;
                if (Array.isArray(data)) {
                    scripts = data;
                } else if (typeof data === 'object' && data !== null) {
                    scripts = Object.keys(data).map(id => ({
                        id: id,
                        ...data[id]
                    }));
                } else {
                    return;
                }
                
                // 检查每个已停止的脚本
                for (const script of scripts) {
                    if (script.status === 'stopped' && script.enabled && script.auto_restart) {
                        // 检查停止原因
                        try {
                            const reasonResponse = await fetch(`/api/scripts/${script.id}/stop-reason`);
                            if (reasonResponse.ok) {
                                const reasonResult = await reasonResponse.json();
                                if (reasonResult.stop_reason === 'crash') {
                                    // 立即显示异常中断状态
                                    updateScriptStatusImmediately(script.id, 'stopped', 'crash');
                                    
                                    // 自动重启
                                    console.log(`🔄 检测到脚本 ${script.id} 异常中断，执行自动重启`);
                                    await startScript(script.id);
                                    
                                    // 显示通知
                                    showToast(`脚本 ${script.name} 异常中断，已自动重启`, 'warning');
                                }
                            }
                        } catch (error) {
                            console.debug(`检查脚本 ${script.id} 停止原因失败:`, error);
                        }
                    }
                }
            } catch (error) {
                console.debug('检查异常中断状态失败:', error);
            }
        }
        
        // 更新停止原因显示
        function updateStopReasonDisplay(scriptId, stopReason) {
            const stopReasonBadge = document.getElementById(`stop-reason-${scriptId}`);
            if (!stopReasonBadge) {
                console.warn(`未找到脚本 ${scriptId} 的停止原因显示元素`);
                return;
            }
            
            // 获取脚本卡片元素和状态徽章
            const scriptCard = document.querySelector(`[data-script-id="${scriptId}"]`);
            const statusBadge = scriptCard ? scriptCard.querySelector('.status-badge') : null;
            
            // 检查脚本是否被禁用，如果被禁用则不显示停止原因
            if (statusBadge && statusBadge.classList.contains('status-disabled')) {
                stopReasonBadge.style.display = 'none';
                stopReasonBadge.classList.remove('flash-red');
                if (scriptCard) {
                    scriptCard.classList.remove('crash-status');
                }
                if (statusBadge) {
                    statusBadge.classList.remove('flash-red');
                }
                console.log(`🚫 脚本 ${scriptId} 已禁用，不显示停止原因`);
                return;
            }
            
            if (stopReason === 'manual') {
                stopReasonBadge.className = 'stop-reason-badge stop-reason-manual flash-red';
                stopReasonBadge.innerHTML = '<i class="bi bi-hand-index"></i> 手动停止';
                stopReasonBadge.style.display = 'inline-block';
                // 移除异常中断的闪烁边框
                if (scriptCard) {
                    scriptCard.classList.remove('crash-status');
                }
                // 为"已停止"状态徽章添加闪烁效果
                if (statusBadge && statusBadge.classList.contains('status-stopped')) {
                    statusBadge.classList.add('flash-red');
                }
                console.log(`✋ 显示脚本 ${scriptId} 手动停止状态`);
            } else if (stopReason === 'crash') {
                stopReasonBadge.className = 'stop-reason-badge stop-reason-crash flash-red';
                stopReasonBadge.innerHTML = '<i class="bi bi-exclamation-triangle"></i> 异常中断';
                stopReasonBadge.style.display = 'inline-block';
                // 添加异常中断的红色闪烁边框
                if (scriptCard) {
                    scriptCard.classList.add('crash-status');
                }
                // 为"已停止"状态徽章添加闪烁效果
                if (statusBadge && statusBadge.classList.contains('status-stopped')) {
                    statusBadge.classList.add('flash-red');
                }
                console.log(`⚠️ 显示脚本 ${scriptId} 异常中断状态，添加红色闪烁边框`);
            } else {
                // 隐藏停止原因显示
                stopReasonBadge.style.display = 'none';
                stopReasonBadge.classList.remove('flash-red');
                // 移除异常中断的闪烁边框
                if (scriptCard) {
                    scriptCard.classList.remove('crash-status');
                }
                // 移除状态徽章的闪烁效果
                if (statusBadge) {
                    statusBadge.classList.remove('flash-red');
                }
                console.log(`🔄 隐藏脚本 ${scriptId} 停止原因显示`);
            }
        }
        
        // 立即更新脚本状态显示（不依赖API响应）
        function updateScriptStatusImmediately(scriptId, status, stopReason = null) {
            const scriptCards = document.querySelectorAll('.script-card');
            scriptCards.forEach(card => {
                const titleElement = card.querySelector('.script-title');
                const cardScriptId = card.getAttribute('data-script-id') || 
                    (titleElement ? titleElement.textContent.trim() : '');
                
                // 通过脚本ID或名称匹配
                if (cardScriptId === scriptId || 
                    (titleElement && titleElement.textContent.includes(scriptId))) {
                    
                    // 立即更新状态徽章
                    const statusBadge = card.querySelector('.status-badge');
                    if (statusBadge) {
                        if (status === 'running') {
                            statusBadge.className = 'status-badge status-running';
                            statusBadge.innerHTML = '<i class="bi bi-play-circle-fill"></i> 运行中';
                            statusBadge.style.display = 'inline-block';
                            // 脚本运行时移除异常中断边框和闪烁效果
                            card.classList.remove('crash-status');
                            statusBadge.classList.remove('flash-red');
                        } else if (status === 'stopped') {
                            statusBadge.className = 'status-badge status-stopped';
                            statusBadge.innerHTML = '<i class="bi bi-stop-circle"></i> 已停止';
                            statusBadge.style.display = 'inline-block';
                        }
                    }
                    
                    // 立即更新停止原因显示
                    if (status === 'stopped' && stopReason) {
                        updateStopReasonDisplay(scriptId, stopReason);
                    } else if (status === 'running') {
                        updateStopReasonDisplay(scriptId, null);
                    }
                    
                    // 立即更新按钮状态
                    const actionsDiv = card.querySelector('.script-actions');
                    if (actionsDiv) {
                        const startStopButton = actionsDiv.querySelector('.btn-start, .btn-stop');
                        if (startStopButton) {
                            if (status === 'running') {
                                startStopButton.className = 'btn btn-stop btn-custom';
                                startStopButton.innerHTML = '<i class="bi bi-stop-fill"></i> 停止';
                                startStopButton.setAttribute('onclick', `stopScript('${scriptId}')`);
                            } else {
                                startStopButton.className = 'btn btn-start btn-custom';
                                startStopButton.innerHTML = '<i class="bi bi-play-fill"></i> 启动';
                                startStopButton.setAttribute('onclick', `startScript('${scriptId}')`);
                            }
                        }
                    }
                    
                    console.log(`⚡ 立即更新脚本 ${scriptId} 状态为: ${status}`);
                }
            });
        }
        
        // 单独更新特定脚本的状态
        async function updateSingleScriptStatus(scriptId) {
            try {
                const response = await fetch('/api/scripts');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                let scripts;
                if (Array.isArray(data)) {
                    scripts = data;
                } else if (typeof data === 'object' && data !== null) {
                    scripts = Object.keys(data).map(id => ({
                        id: id,
                        ...data[id]
                    }));
                } else {
                    throw new Error('API返回的数据格式不正确');
                }
                
                const targetScript = scripts.find(s => s.id === scriptId);
                if (targetScript) {
                    // 找到对应的脚本卡片并更新状态
                    const scriptCards = document.querySelectorAll('.script-card');
                    scriptCards.forEach(card => {
                        const titleElement = card.querySelector('.script-title');
                        if (titleElement && titleElement.textContent === targetScript.name) {
                            // 更新状态徽章
                            const statusBadge = card.querySelector('.status-badge');
                            if (statusBadge) {
                                const statusText = getStatusText(targetScript);
                                if (statusText) {
                                    const baseClassName = `status-badge status-${getStatusClass(targetScript)}`;
                                    // 如果脚本已停止且有停止原因，保持闪烁效果
                                    if (targetScript.status === 'stopped' && targetScript.stop_reason) {
                                        statusBadge.className = `${baseClassName} flash-red`;
                                    } else {
                                        statusBadge.className = baseClassName;
                                    }
                                    statusBadge.innerHTML = `<i class="bi bi-${getStatusIcon(targetScript)}"></i> ${statusText}`;
                                    statusBadge.style.display = 'inline-block';
                                } else {
                                    statusBadge.style.display = 'none';
                                }
                            }
                            
                            // 更新按钮
                            const actionsDiv = card.querySelector('.script-actions');
                            if (actionsDiv) {
                                const startStopButton = actionsDiv.querySelector('.btn-start, .btn-stop');
                                if (startStopButton) {
                                    if (targetScript.status === 'running') {
                                        startStopButton.className = 'btn btn-stop btn-custom';
                                        startStopButton.innerHTML = '<i class="bi bi-stop-fill"></i> 停止';
                                        startStopButton.setAttribute('onclick', `stopScript('${targetScript.id}')`);
                                    } else {
                                        startStopButton.className = 'btn btn-start btn-custom';
                                        startStopButton.innerHTML = '<i class="bi bi-play-fill"></i> 启动';
                                        startStopButton.setAttribute('onclick', `startScript('${targetScript.id}')`);
                                    }
                                }
                            }
                            
                            // 处理停止原因显示
                            if (targetScript.status === 'running') {
                                // 脚本正在运行时，清除停止原因显示
                                updateStopReasonDisplay(targetScript.id, null);
                            } else if (targetScript.status === 'stopped' && targetScript.stop_reason) {
                                // 脚本已停止且有停止原因时，显示停止原因
                                updateStopReasonDisplay(targetScript.id, targetScript.stop_reason);
                            }
                            
                            // 处理CMD输出容器
                            const existingCmdOutput = card.querySelector(`#cmd-output-${targetScript.id}`);
                            if (targetScript.status === 'running') {
                                
                                // 如果脚本正在运行但没有CMD输出容器，则创建一个
                                if (!existingCmdOutput) {
                                    const cmdOutputHtml = `
                                        <div class="cmd-output-container" id="cmd-output-${targetScript.id}">
                                            <div class="cmd-output-header">
                                                <span class="cmd-output-title">
                                                    <i class="bi bi-terminal"></i> 实时输出
                                                </span>
                                                <button class="btn btn-sm btn-outline-light" onclick="toggleCmdOutput('${targetScript.id}')" id="toggle-cmd-${targetScript.id}">
                                                    <i class="bi bi-chevron-up"></i>
                                                </button>
                                            </div>
                                            <div class="cmd-output-content" id="cmd-content-${targetScript.id}">
                                                <div class="loading-output">正在加载输出...</div>
                                            </div>
                                        </div>
                                    `;
                                    // 在script-actions之前插入CMD输出容器
                                    actionsDiv.insertAdjacentHTML('beforebegin', cmdOutputHtml);
                                    // 立即更新CMD输出
                                    setTimeout(() => updateCmdOutput(targetScript.id), 100);
                                }
                            } else {
                                // 脚本已停止，但保留CMD输出容器（永不删除）
                                // CMD输出容器将继续显示最后的输出内容
                            }
                        }
                    });
                    
                    // 更新统计信息
                    updateStats(scripts);
                }
            } catch (error) {
                console.error('更新脚本状态失败:', error);
                // 如果单独更新失败，回退到全局刷新
                loadScripts();
            }
        }

        // 通知历史记录
        let notificationHistory = JSON.parse(localStorage.getItem('notificationHistory') || '[]');
        
        // 显示Toast通知
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastBody = document.getElementById('toast-body');
            const toastIcon = document.getElementById('toast-icon');
            
            // 设置消息内容
            toastBody.textContent = message;
            
            // 设置图标
            let iconClass = 'bi-info-circle';
            if (type === 'success') {
                iconClass = 'bi-check-circle';
            } else if (type === 'error') {
                iconClass = 'bi-exclamation-triangle';
            } else if (type === 'warning') {
                iconClass = 'bi-exclamation-triangle';
            }
            toastIcon.className = `bi ${iconClass} text-primary me-2`;
            
            // 设置样式
            toast.className = 'toast';
            if (type === 'success') {
                toast.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                toast.classList.add('bg-danger', 'text-white');
            } else if (type === 'warning') {
                toast.classList.add('bg-warning');
            } else {
                toast.classList.add('bg-info', 'text-white');
            }
            
            // 添加到历史记录
            addToNotificationHistory(message, type);
            
            // 显示Toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
        
        // 添加到通知历史
        function addToNotificationHistory(message, type) {
            const notification = {
                id: Date.now(),
                message: message,
                type: type,
                timestamp: new Date().toLocaleString('zh-CN')
            };
            
            // 添加到数组开头
            notificationHistory.unshift(notification);
            
            // 保持最多100条记录
            if (notificationHistory.length > 100) {
                notificationHistory = notificationHistory.slice(0, 100);
            }
            
            // 保存到本地存储
            localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
        }
        
        // 显示通知历史
        function showNotificationHistory() {
            const modal = new bootstrap.Modal(document.getElementById('notificationHistoryModal'));
            renderNotificationHistory();
            modal.show();
        }
        
        // 渲染通知历史
        function renderNotificationHistory() {
            const container = document.getElementById('notification-history-list');
            
            if (notificationHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox"></i>
                        <p class="mt-2">暂无通知记录</p>
                    </div>
                `;
                return;
            }
            
            const historyHtml = notificationHistory.map(notification => {
                const typeInfo = getNotificationTypeInfo(notification.type);
                return `
                    <div class="notification-item ${notification.type}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="notification-message">
                                    <i class="bi ${typeInfo.icon} me-2"></i>
                                    ${escapeHtml(notification.message)}
                                </div>
                                <div class="notification-time">
                                    <i class="bi bi-clock me-1"></i>
                                    ${notification.timestamp}
                                </div>
                            </div>
                            <span class="notification-type-badge ${typeInfo.badgeClass}">
                                ${typeInfo.label}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = historyHtml;
        }
        
        // 获取通知类型信息
        function getNotificationTypeInfo(type) {
            const typeMap = {
                'success': {
                    icon: 'bi-check-circle',
                    label: '成功',
                    badgeClass: 'bg-success text-white'
                },
                'error': {
                    icon: 'bi-exclamation-triangle',
                    label: '错误',
                    badgeClass: 'bg-danger text-white'
                },
                'warning': {
                    icon: 'bi-exclamation-triangle',
                    label: '警告',
                    badgeClass: 'bg-warning text-dark'
                },
                'info': {
                    icon: 'bi-info-circle',
                    label: '信息',
                    badgeClass: 'bg-info text-white'
                }
            };
            
            return typeMap[type] || typeMap['info'];
        }
        
        // 清空通知历史
        function clearNotificationHistory() {
            if (confirm('确定要清空所有通知历史吗？此操作不可恢复。')) {
                notificationHistory = [];
                localStorage.removeItem('notificationHistory');
                renderNotificationHistory();
                showToast('通知历史已清空', 'info');
            }
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== 分组管理功能 ==========
        
        // 渲染分组视图
        function renderGroupedScripts(scripts) {
            const container = document.getElementById('scripts-container');
            
            if (scripts.length === 0 && groupsData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
                        <h4 class="text-muted mt-3">暂无脚本和分组</h4>
                        <p class="text-muted">点击上方"添加脚本"或"创建分组"按钮开始</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // 渲染分组
            groupsData.forEach(group => {
                const groupScripts = scripts.filter(script => 
                    group.scripts && group.scripts.includes(script.id)
                );
                
                html += `
                    <div class="group-container" data-group-id="${group.id}" 
                         ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="group-header">
                            <h4 class="group-title">
                                <i class="bi bi-folder"></i> ${group.name}
                                <span class="badge bg-secondary ms-2">${groupScripts.length}</span>
                            </h4>
                            <div class="group-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editGroup('${group.id}')" title="编辑分组">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteGroup('${group.id}')" title="删除分组">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        ${group.description ? `<p class="text-muted mb-3">${group.description}</p>` : ''}
                        <div class="group-scripts">
                            ${groupScripts.length > 0 ? 
                                groupScripts.map(script => createScriptCard(script)).join('') :
                                '<div class="group-empty-message">拖拽脚本到此分组</div>'
                            }
                        </div>
                    </div>
                `;
            });
            
            // 渲染未分组脚本
            const ungroupedScriptObjects = scripts.filter(script => 
                ungroupedScripts.includes(script.id)
            );
            
            if (ungroupedScriptObjects.length > 0) {
                html += `
                    <div class="ungrouped-container" data-group-id="" 
                         ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="group-header">
                            <h4 class="group-title">
                                <i class="bi bi-files"></i> 未分组脚本
                                <span class="badge bg-warning text-dark ms-2">${ungroupedScriptObjects.length}</span>
                            </h4>
                        </div>
                        <div class="group-scripts">
                            ${ungroupedScriptObjects.map(script => createScriptCard(script)).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // 渲染完成后处理停止原因显示
            setTimeout(() => {
                scripts.forEach(script => {
                    if (script.status === 'stopped') {
                        checkStopReasonAndHandle(script);
                    }
                });
            }, 100);
        }
        
        // 切换视图模式
        function toggleGroupView() {
            isGroupView = !isGroupView;
            const toggleBtn = document.getElementById('view-toggle-text');
            const toggleIcon = document.getElementById('view-toggle-icon');
            
            if (isGroupView) {
                toggleBtn.textContent = '列表视图';
                toggleIcon.className = 'bi bi-list';
            } else {
                toggleBtn.textContent = '分组视图';
                toggleIcon.className = 'bi bi-grid-3x3-gap';
            }
            
            loadScriptsAndGroups();
        }
        
        // 显示创建分组模态框
        function showCreateGroupModal() {
            document.getElementById('groupId').value = '';
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('createGroupModal'));
            modal.show();
        }
        
        // 创建分组
        async function createGroup() {
            const groupId = document.getElementById('groupId').value.trim();
            const groupName = document.getElementById('groupName').value.trim();
            const groupDescription = document.getElementById('groupDescription').value.trim();
            
            if (!groupId || !groupName) {
                showToast('请填写分组ID和名称', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/groups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: groupId,
                        name: groupName,
                        description: groupDescription
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('分组创建成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createGroupModal')).hide();
                    loadScriptsAndGroups();
                } else {
                    showToast(result.message || '创建分组失败', 'error');
                }
            } catch (error) {
                console.error('创建分组失败:', error);
                showToast('创建分组失败: ' + error.message, 'error');
            }
        }
        
        // 编辑分组
        function editGroup(groupId) {
            const group = groupsData.find(g => g.id === groupId);
            if (!group) {
                showToast('分组不存在', 'error');
                return;
            }
            
            document.getElementById('editGroupId').value = groupId;
            document.getElementById('editGroupName').value = group.name;
            document.getElementById('editGroupDescription').value = group.description || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editGroupModal'));
            modal.show();
        }
        
        // 更新分组
        async function updateGroup() {
            const groupId = document.getElementById('editGroupId').value;
            const groupName = document.getElementById('editGroupName').value.trim();
            const groupDescription = document.getElementById('editGroupDescription').value.trim();
            
            if (!groupName) {
                showToast('请填写分组名称', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/groups/${groupId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: groupName,
                        description: groupDescription
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('分组更新成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editGroupModal')).hide();
                    loadScriptsAndGroups();
                } else {
                    showToast(result.message || '更新分组失败', 'error');
                }
            } catch (error) {
                console.error('更新分组失败:', error);
                showToast('更新分组失败: ' + error.message, 'error');
            }
        }
        
        // 删除分组
        async function deleteGroup(groupId) {
            const group = groupsData.find(g => g.id === groupId);
            if (!group) {
                showToast('分组不存在', 'error');
                return;
            }
            
            if (!confirm(`确定要删除分组"${group.name}"吗？\n分组中的脚本将移动到未分组区域。`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/groups/${groupId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('分组删除成功', 'success');
                    loadScriptsAndGroups();
                } else {
                    showToast(result.message || '删除分组失败', 'error');
                }
            } catch (error) {
                console.error('删除分组失败:', error);
                showToast('删除分组失败: ' + error.message, 'error');
            }
        }
        
        // ========== 拖拽功能 ==========
        
        // 拖拽开始
        function handleDragStart(event) {
            if (!isDragEnabled) {
                event.preventDefault();
                return;
            }
            
            draggedScript = event.target.getAttribute('data-script-id');
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', draggedScript);
        }
        
        // 拖拽结束
        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedScript = null;
            
            // 清除所有拖拽样式
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        }
        
        // 拖拽悬停
        function handleDragOver(event) {
            if (!isDragEnabled || !draggedScript) return;
            
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const container = event.currentTarget;
            if (!container.classList.contains('drag-over')) {
                container.classList.add('drag-over');
            }
        }
        
        // 拖拽离开
        function handleDragLeave(event) {
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            const x = event.clientX;
            const y = event.clientY;
            
            // 检查鼠标是否真的离开了容器
            if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                container.classList.remove('drag-over');
            }
        }
        
        // 拖拽放置
        async function handleDrop(event) {
            if (!isDragEnabled || !draggedScript) return;
            
            event.preventDefault();
            const container = event.currentTarget;
            container.classList.remove('drag-over');
            
            const targetGroupId = container.getAttribute('data-group-id');
            
            try {
                const response = await fetch(`/api/scripts/${draggedScript}/group`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        group_id: targetGroupId || null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const targetGroupName = targetGroupId ? 
                        groupsData.find(g => g.id === targetGroupId)?.name || '未知分组' : 
                        '未分组';
                    showToast(`脚本已移动到"${targetGroupName}"`, 'success');
                    loadScriptsAndGroups();
                } else {
                    showToast(result.message || '移动脚本失败', 'error');
                }
            } catch (error) {
                console.error('移动脚本失败:', error);
                showToast('移动脚本失败: ' + error.message, 'error');
            }
        }
        
        // 切换拖拽功能
        document.getElementById('enableDragDrop').addEventListener('change', function(event) {
            isDragEnabled = event.target.checked;
            
            // 更新所有脚本卡片的拖拽属性
            document.querySelectorAll('.script-card').forEach(card => {
                if (isDragEnabled) {
                    card.setAttribute('draggable', 'true');
                } else {
                    card.removeAttribute('draggable');
                }
            });
        });
    </script>
</body>
</html>